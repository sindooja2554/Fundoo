"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

const fs = require('fs');

const os = require('os');

const path = require('path');

const dayjs = require('dayjs');

const debug = require('debug')('preview-email');

const nodemailer = require('nodemailer');

const open = require('open');

const pify = require('pify');

const pug = require('pug');

const uuid = require('uuid');

const {
  simpleParser
} = require('mailparser');

const writeFile = pify(fs.writeFile);
const transport = nodemailer.createTransport({
  streamTransport: true,
  buffer: true
});
const templateFilePath = path.join(__dirname, '..', 'template.pug');
const renderFilePromise = pify(pug.renderFile);

const previewEmail = async (message, options) => {
  options = _objectSpread({
    dir: os.tmpdir(),
    id: uuid.v4(),
    open: {
      wait: false
    },
    template: templateFilePath
  }, options);
  debug('message', message, 'options', options);
  if (typeof message !== 'object') throw new Error('Message argument is required');
  const res = await transport.sendMail(message);
  const parsed = await simpleParser(res.message);
  console.log('parsed', parsed);
  console.log('parsed.attachments', parsed.attachments);
  const html = await renderFilePromise(options.template, Object.assign(parsed, {
    cache: true,
    pretty: true,
    dayjs
  }));
  const filePath = `${options.dir}/${options.id}.html`;
  debug('filePath', filePath);
  await writeFile(filePath, html);
  if (options.open) await open(filePath, options.open);
  return `file://${filePath}`;
};

module.exports = previewEmail;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJvcyIsInBhdGgiLCJkYXlqcyIsImRlYnVnIiwibm9kZW1haWxlciIsIm9wZW4iLCJwaWZ5IiwicHVnIiwidXVpZCIsInNpbXBsZVBhcnNlciIsIndyaXRlRmlsZSIsInRyYW5zcG9ydCIsImNyZWF0ZVRyYW5zcG9ydCIsInN0cmVhbVRyYW5zcG9ydCIsImJ1ZmZlciIsInRlbXBsYXRlRmlsZVBhdGgiLCJqb2luIiwiX19kaXJuYW1lIiwicmVuZGVyRmlsZVByb21pc2UiLCJyZW5kZXJGaWxlIiwicHJldmlld0VtYWlsIiwibWVzc2FnZSIsIm9wdGlvbnMiLCJkaXIiLCJ0bXBkaXIiLCJpZCIsInY0Iiwid2FpdCIsInRlbXBsYXRlIiwiRXJyb3IiLCJyZXMiLCJzZW5kTWFpbCIsInBhcnNlZCIsImNvbnNvbGUiLCJsb2ciLCJhdHRhY2htZW50cyIsImh0bWwiLCJPYmplY3QiLCJhc3NpZ24iLCJjYWNoZSIsInByZXR0eSIsImZpbGVQYXRoIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBLE1BQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLElBQUQsQ0FBbEI7O0FBQ0EsTUFBTUMsRUFBRSxHQUFHRCxPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFDQSxNQUFNRSxJQUFJLEdBQUdGLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUVBLE1BQU1HLEtBQUssR0FBR0gsT0FBTyxDQUFDLE9BQUQsQ0FBckI7O0FBQ0EsTUFBTUksS0FBSyxHQUFHSixPQUFPLENBQUMsT0FBRCxDQUFQLENBQWlCLGVBQWpCLENBQWQ7O0FBQ0EsTUFBTUssVUFBVSxHQUFHTCxPQUFPLENBQUMsWUFBRCxDQUExQjs7QUFDQSxNQUFNTSxJQUFJLEdBQUdOLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1PLElBQUksR0FBR1AsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTVEsR0FBRyxHQUFHUixPQUFPLENBQUMsS0FBRCxDQUFuQjs7QUFDQSxNQUFNUyxJQUFJLEdBQUdULE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU07QUFBRVUsRUFBQUE7QUFBRixJQUFtQlYsT0FBTyxDQUFDLFlBQUQsQ0FBaEM7O0FBRUEsTUFBTVcsU0FBUyxHQUFHSixJQUFJLENBQUNSLEVBQUUsQ0FBQ1ksU0FBSixDQUF0QjtBQUVBLE1BQU1DLFNBQVMsR0FBR1AsVUFBVSxDQUFDUSxlQUFYLENBQTJCO0FBQzNDQyxFQUFBQSxlQUFlLEVBQUUsSUFEMEI7QUFFM0NDLEVBQUFBLE1BQU0sRUFBRTtBQUZtQyxDQUEzQixDQUFsQjtBQUtBLE1BQU1DLGdCQUFnQixHQUFHZCxJQUFJLENBQUNlLElBQUwsQ0FBVUMsU0FBVixFQUFxQixJQUFyQixFQUEyQixjQUEzQixDQUF6QjtBQUVBLE1BQU1DLGlCQUFpQixHQUFHWixJQUFJLENBQUNDLEdBQUcsQ0FBQ1ksVUFBTCxDQUE5Qjs7QUFFQSxNQUFNQyxZQUFZLEdBQUcsT0FBT0MsT0FBUCxFQUFnQkMsT0FBaEIsS0FBNEI7QUFDL0NBLEVBQUFBLE9BQU87QUFDTEMsSUFBQUEsR0FBRyxFQUFFdkIsRUFBRSxDQUFDd0IsTUFBSCxFQURBO0FBRUxDLElBQUFBLEVBQUUsRUFBRWpCLElBQUksQ0FBQ2tCLEVBQUwsRUFGQztBQUdMckIsSUFBQUEsSUFBSSxFQUFFO0FBQUVzQixNQUFBQSxJQUFJLEVBQUU7QUFBUixLQUhEO0FBSUxDLElBQUFBLFFBQVEsRUFBRWI7QUFKTCxLQUtGTyxPQUxFLENBQVA7QUFPQW5CLEVBQUFBLEtBQUssQ0FBQyxTQUFELEVBQVlrQixPQUFaLEVBQXFCLFNBQXJCLEVBQWdDQyxPQUFoQyxDQUFMO0FBRUEsTUFBSSxPQUFPRCxPQUFQLEtBQW1CLFFBQXZCLEVBQ0UsTUFBTSxJQUFJUSxLQUFKLENBQVUsOEJBQVYsQ0FBTjtBQUVGLFFBQU1DLEdBQUcsR0FBRyxNQUFNbkIsU0FBUyxDQUFDb0IsUUFBVixDQUFtQlYsT0FBbkIsQ0FBbEI7QUFFQSxRQUFNVyxNQUFNLEdBQUcsTUFBTXZCLFlBQVksQ0FBQ3FCLEdBQUcsQ0FBQ1QsT0FBTCxDQUFqQztBQUVBWSxFQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxRQUFaLEVBQXNCRixNQUF0QjtBQUNBQyxFQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxvQkFBWixFQUFrQ0YsTUFBTSxDQUFDRyxXQUF6QztBQUVBLFFBQU1DLElBQUksR0FBRyxNQUFNbEIsaUJBQWlCLENBQ2xDSSxPQUFPLENBQUNNLFFBRDBCLEVBRWxDUyxNQUFNLENBQUNDLE1BQVAsQ0FBY04sTUFBZCxFQUFzQjtBQUNwQk8sSUFBQUEsS0FBSyxFQUFFLElBRGE7QUFFcEJDLElBQUFBLE1BQU0sRUFBRSxJQUZZO0FBR3BCdEMsSUFBQUE7QUFIb0IsR0FBdEIsQ0FGa0MsQ0FBcEM7QUFTQSxRQUFNdUMsUUFBUSxHQUFJLEdBQUVuQixPQUFPLENBQUNDLEdBQUksSUFBR0QsT0FBTyxDQUFDRyxFQUFHLE9BQTlDO0FBQ0F0QixFQUFBQSxLQUFLLENBQUMsVUFBRCxFQUFhc0MsUUFBYixDQUFMO0FBQ0EsUUFBTS9CLFNBQVMsQ0FBQytCLFFBQUQsRUFBV0wsSUFBWCxDQUFmO0FBRUEsTUFBSWQsT0FBTyxDQUFDakIsSUFBWixFQUFrQixNQUFNQSxJQUFJLENBQUNvQyxRQUFELEVBQVduQixPQUFPLENBQUNqQixJQUFuQixDQUFWO0FBRWxCLFNBQVEsVUFBU29DLFFBQVMsRUFBMUI7QUFDRCxDQXBDRDs7QUFzQ0FDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnZCLFlBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuY29uc3Qgb3MgPSByZXF1aXJlKCdvcycpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcblxuY29uc3QgZGF5anMgPSByZXF1aXJlKCdkYXlqcycpO1xuY29uc3QgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpKCdwcmV2aWV3LWVtYWlsJyk7XG5jb25zdCBub2RlbWFpbGVyID0gcmVxdWlyZSgnbm9kZW1haWxlcicpO1xuY29uc3Qgb3BlbiA9IHJlcXVpcmUoJ29wZW4nKTtcbmNvbnN0IHBpZnkgPSByZXF1aXJlKCdwaWZ5Jyk7XG5jb25zdCBwdWcgPSByZXF1aXJlKCdwdWcnKTtcbmNvbnN0IHV1aWQgPSByZXF1aXJlKCd1dWlkJyk7XG5jb25zdCB7IHNpbXBsZVBhcnNlciB9ID0gcmVxdWlyZSgnbWFpbHBhcnNlcicpO1xuXG5jb25zdCB3cml0ZUZpbGUgPSBwaWZ5KGZzLndyaXRlRmlsZSk7XG5cbmNvbnN0IHRyYW5zcG9ydCA9IG5vZGVtYWlsZXIuY3JlYXRlVHJhbnNwb3J0KHtcbiAgc3RyZWFtVHJhbnNwb3J0OiB0cnVlLFxuICBidWZmZXI6IHRydWVcbn0pO1xuXG5jb25zdCB0ZW1wbGF0ZUZpbGVQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJ3RlbXBsYXRlLnB1ZycpO1xuXG5jb25zdCByZW5kZXJGaWxlUHJvbWlzZSA9IHBpZnkocHVnLnJlbmRlckZpbGUpO1xuXG5jb25zdCBwcmV2aWV3RW1haWwgPSBhc3luYyAobWVzc2FnZSwgb3B0aW9ucykgPT4ge1xuICBvcHRpb25zID0ge1xuICAgIGRpcjogb3MudG1wZGlyKCksXG4gICAgaWQ6IHV1aWQudjQoKSxcbiAgICBvcGVuOiB7IHdhaXQ6IGZhbHNlIH0sXG4gICAgdGVtcGxhdGU6IHRlbXBsYXRlRmlsZVBhdGgsXG4gICAgLi4ub3B0aW9uc1xuICB9O1xuICBkZWJ1ZygnbWVzc2FnZScsIG1lc3NhZ2UsICdvcHRpb25zJywgb3B0aW9ucyk7XG5cbiAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSAnb2JqZWN0JylcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ01lc3NhZ2UgYXJndW1lbnQgaXMgcmVxdWlyZWQnKTtcblxuICBjb25zdCByZXMgPSBhd2FpdCB0cmFuc3BvcnQuc2VuZE1haWwobWVzc2FnZSk7XG5cbiAgY29uc3QgcGFyc2VkID0gYXdhaXQgc2ltcGxlUGFyc2VyKHJlcy5tZXNzYWdlKTtcblxuICBjb25zb2xlLmxvZygncGFyc2VkJywgcGFyc2VkKTtcbiAgY29uc29sZS5sb2coJ3BhcnNlZC5hdHRhY2htZW50cycsIHBhcnNlZC5hdHRhY2htZW50cyk7XG5cbiAgY29uc3QgaHRtbCA9IGF3YWl0IHJlbmRlckZpbGVQcm9taXNlKFxuICAgIG9wdGlvbnMudGVtcGxhdGUsXG4gICAgT2JqZWN0LmFzc2lnbihwYXJzZWQsIHtcbiAgICAgIGNhY2hlOiB0cnVlLFxuICAgICAgcHJldHR5OiB0cnVlLFxuICAgICAgZGF5anNcbiAgICB9KVxuICApO1xuXG4gIGNvbnN0IGZpbGVQYXRoID0gYCR7b3B0aW9ucy5kaXJ9LyR7b3B0aW9ucy5pZH0uaHRtbGA7XG4gIGRlYnVnKCdmaWxlUGF0aCcsIGZpbGVQYXRoKTtcbiAgYXdhaXQgd3JpdGVGaWxlKGZpbGVQYXRoLCBodG1sKTtcblxuICBpZiAob3B0aW9ucy5vcGVuKSBhd2FpdCBvcGVuKGZpbGVQYXRoLCBvcHRpb25zLm9wZW4pO1xuXG4gIHJldHVybiBgZmlsZTovLyR7ZmlsZVBhdGh9YDtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gcHJldmlld0VtYWlsO1xuIl19